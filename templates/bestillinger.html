<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestillinger</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {% include "navigation/_navbar.html" %}

    <div class="centered-page is-wide">
        <h1>
            {% if role == 'personlig' %} Mine Bestillinger
            {% elif role == 'kjokken' %} Aktive Bestillinger
            {% elif role == 'okonomi' %} Ferdige Bestillinger
            {% elif role == 'admin' %} Alle Bestillinger
            {% endif %}
        </h1>

        {% if role != 'personlig' %}
        <div class="search-toolbar">
            <input id="userSearch" class="user-search" type="text" placeholder="Søk etter navn..."
                oninput="filterUsers()">
            <svg class="icon">
                <use href="#icon-search"></use>
            </svg>
        </div>
        {% endif %}

        <div class="menu-category orders-grid">

            {% if order_info %}
            {% for o in order_info %}
            <div id="order-card-{{ o.id }}" class="receipt-card order-item" data-client-name="{{ o.navn | lower }}">

                <div class="receipt-header">
                    <h3>#{{ o.id }}</h3>
                    {% if o.menu_source %}
                    <p><strong>{{ o.menu_source }}</strong></p>
                    {% endif %}
                    <div class="receipt-date">
                        {{ o.ordre_dato | format_date }}<br>
                        {{ o.ordre_tid | format_time }}
                    </div>
                </div>

                <div class="receipt-body">

                    {% if role != 'personlig' %}
                    <p id="kunde-navn"><strong>Kunde:</strong> {{ o.navn }}</p>
                    {% endif %}
                    {% if o.spise_i_kantina != 'Nei' and o.menu_source == 'Kantina' %}
                    <p><strong>Kommer:</strong> {{ o.hent_dato | format_date }} | kl. {{ o.hent_tid | format_time }}</p>
                    <p>{{ o.spise_i_kantina }} skal spise i kantina</p>
                    {% else %}
                    <p><strong>Hentes:</strong> {{ o.hent_dato | format_date }} | kl. {{ o.hent_tid | format_time }}</p>
                    <p><strong>Sum:</strong> {{ o.sum | int }} kr</p>
                    {% endif %}

                    {% if role == 'personlig' %}
                    <div style="margin-top: 10px;">
                        {% if o.status_levert %}
                        <span class="receipt-status-badge status-success">Levert</span>
                        {% else %}
                        <span class="receipt-status-badge status-pending">Behandling</span>
                        {% endif %}
                    </div>

                    {% else %}
                    <p class="les-mer" onclick="toggleReadMore(event)" style="margin-top:0.5rem;">Vis detaljer ▼</p>
                    <div class="description receipt-details-list" style="display: none; font-size: 0.9rem;">
                        <p><strong>Kunde-ID:</strong> {{ o.kunde_id }}</p>
                        <p><strong>Mobil:</strong> {{ o.mobil }}</p>
                        <p><strong>E-post:</strong> <a href="mailto:{{ o.epost }}">{{ o.epost }}</a></p>
                        {% if o.organisasjonsnummer or o.koststed or o.ressursnummer or o.fakturaadresse or o.melding %}
                        <hr style="border: 0; border-top: 1px solid #ccc; margin: 5px 0;">
                        {% endif %}
                        {% if o.organisasjonsnummer %}
                        <p><strong>Org.nr:</strong> {{ o.organisasjonsnummer }}</p>
                        {% endif %}
                        {% if o.ressursnummer %}
                        <p><strong>Ressursnr:</strong> {{ o.ressursnummer }}</p>
                        {% endif %}
                        {% if o.fakturaadresse %}
                        <p><strong>Koststed:</strong> {{ o.fakturaadresse }}</p>
                        {% endif %}
                        {% if o.koststed %}
                        <p><strong>Koststed:</strong> {{ o.koststed }}</p>
                        {% endif %}
                        {% if o.melding %}
                        <p><strong>Melding:</strong> {{ o.melding }}</p>
                        {% endif %}
                    </div>

                    <div style="margin-top: 10px; display: flex; gap: 5px; flex-direction: column;">
                        {% if o.status_levert %}
                        <span class="receipt-status-badge status-success">Levert</span>
                        {% else %}
                        <span class="receipt-status-badge status-pending">Venter kjøkken</span>
                        {% endif %}

                        {% if role == 'admin' or role == 'okonomi' %}
                        {% if o.status_fakturert %}
                        <span class="receipt-status-badge status-info">Fakturert</span>
                        {% else %}
                        <span class="receipt-status-badge status-pending">Ikke fakturert</span>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="receipt-actions">
                    <a href="/vis-bestilling/{{ o.id }}">
                        <button class="btn-secondary">
                            <svg class="icon">
                                <use href="#icon-clipboard"></use>
                            </svg>
                            Se kvittering
                        </button>
                    </a>

                    {% if role == 'kjokken' and not o.status_levert %}
                    <form method="POST" action="/sett-levert/{{ o.id }}"
                        onsubmit="handleAction(event, 'order-card-{{ o.id }}', 'lever')">
                        <button type="submit">✓ Sett som levert</button>
                    </form>
                    {% endif %}

                    {% if role == 'okonomi' and not o.status_fakturert %}
                    <form method="POST" action="/sett-fakturert/{{ o.id }}"
                        onsubmit="handleAction(event, 'order-card-{{ o.id }}', 'fakturer')">
                        <button type="submit">✓ Merk fakturert</button>
                    </form>
                    {% endif %}

                    {% if role == 'admin' %}
                    <form method="POST" action="/slett-bestilling/{{ o.id }}"
                        onsubmit="handleAction(event, 'order-card-{{ o.id }}', 'delete')">
                        <button type="submit" class="btn-danger" onclick="return confirm('Delete?')">
                            <svg class="icon">
                                <use href="#icon-trash"></use>
                            </svg>
                            Slett
                        </button>
                    </form>
                    {% endif %}
                </div>

            </div>
            {% endfor %}
            {% else %}
            <p style="width: 100%; grid-column: 2;">Ingen bestillinger funnet.</p>
            {% endif %}
        </div>
    </div>

    {% include "navigation/back_to_top.html" %}
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>